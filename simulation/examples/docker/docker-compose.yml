version: '3.8'

# Luciferase Distributed Simulation - Docker Compose
#
# Quick Start:
#   1. Build image: docker build -t luciferase:latest -f Dockerfile ../../..
#   2. Generate certs: ./generate-certs.sh (see DEPLOYMENT_GUIDE.md)
#   3. Start cluster: docker-compose up -d
#   4. View logs: docker-compose logs -f
#   5. Stop cluster: docker-compose down
#
# Production: See ../DEPLOYMENT_GUIDE.md for TLS, monitoring, and Kubernetes deployment

services:
  # Node 1 - Spatial bounds (0-50)³
  node1:
    image: luciferase:latest
    container_name: luciferase-node1
    hostname: node1
    environment:
      # Node configuration
      NODE_NAME: Node1
      MY_PORT: 9000
      PEER_HOST: node2
      PEER_PORT: 9001

      # TLS configuration (production)
      TLS_ENABLED: ${TLS_ENABLED:-false}
      CERT_PATH: /certs/node1-cert.pem
      KEY_PATH: /certs/node1-key.pem
      CA_CERT_PATH: /certs/ca-cert.pem

      # JVM tuning
      JAVA_OPTS: >-
        -Xms2g -Xmx2g
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=20
        -XX:+ParallelRefProcEnabled
        -XX:+UseStringDeduplication
        -XX:+AlwaysPreTouch

      # Logging
      LOG_LEVEL: INFO

    volumes:
      # TLS certificates (optional for development)
      - ./certs:/certs:ro
      # Persistent data (checkpoints)
      - ./data/node1:/data
      # Configuration
      - ./config:/config:ro

    networks:
      - luciferase-net

    ports:
      # Health check endpoint
      - "8081:8080"
      # Metrics endpoint (Prometheus)
      - "9091:9090"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Node 2 - Spatial bounds (50-100)³
  node2:
    image: luciferase:latest
    container_name: luciferase-node2
    hostname: node2
    environment:
      # Node configuration
      NODE_NAME: Node2
      MY_PORT: 9001
      PEER_HOST: node1
      PEER_PORT: 9000

      # TLS configuration (production)
      TLS_ENABLED: ${TLS_ENABLED:-false}
      CERT_PATH: /certs/node2-cert.pem
      KEY_PATH: /certs/node2-key.pem
      CA_CERT_PATH: /certs/ca-cert.pem

      # JVM tuning
      JAVA_OPTS: >-
        -Xms2g -Xmx2g
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=20
        -XX:+ParallelRefProcEnabled
        -XX:+UseStringDeduplication
        -XX:+AlwaysPreTouch

      # Logging
      LOG_LEVEL: INFO

    volumes:
      # TLS certificates (optional for development)
      - ./certs:/certs:ro
      # Persistent data (checkpoints)
      - ./data/node2:/data
      # Configuration
      - ./config:/config:ro

    networks:
      - luciferase-net

    ports:
      # Health check endpoint
      - "8082:8080"
      # Metrics endpoint (Prometheus)
      - "9092:9090"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

    depends_on:
      node1:
        condition: service_healthy

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G

  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: luciferase-prometheus
    hostname: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'

    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus

    networks:
      - luciferase-net

    ports:
      - "9090:9090"

    restart: unless-stopped

    depends_on:
      - node1
      - node2

  # Grafana - Visualization dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: luciferase-grafana
    hostname: grafana
    environment:
      # Admin credentials (change in production)
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      # Datasource configuration
      GF_DATASOURCES_DEFAULT: prometheus

    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro

    networks:
      - luciferase-net

    ports:
      - "3000:3000"

    restart: unless-stopped

    depends_on:
      - prometheus

  # Jaeger - Distributed tracing (optional)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: luciferase-jaeger
    hostname: jaeger
    environment:
      COLLECTOR_ZIPKIN_HOST_PORT: ":9411"
      COLLECTOR_OTLP_ENABLED: "true"

    networks:
      - luciferase-net

    ports:
      # Jaeger UI
      - "16686:16686"
      # OTLP gRPC receiver
      - "4317:4317"
      # OTLP HTTP receiver
      - "4318:4318"

    restart: unless-stopped

networks:
  luciferase-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
