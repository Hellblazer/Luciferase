# H3.7 Execution Plan: Wall-Clock Conversion

**Date**: 2026-01-12 (Revised)
**Parent Bead**: Luciferase-xve9 (H3.7)
**Status**: READY FOR EXECUTION
**Audit Reference**: simulation/doc/H3.7_WALL_CLOCK_AUDIT.md
**Version**: 2.0

---

## Executive Summary

Convert 113 `System.currentTimeMillis()` and `System.nanoTime()` calls to the Clock interface across 4 phases. This enables deterministic testing for the simulation module.

**Scope**: 113 calls in 54 files (excluding 7 legitimate Clock.java/TestClock.java calls)
**Timeline**: 7 working days + 1.5 days buffer = 8.5 days realistic
**Risk Level**: Medium (Phase 1 high-risk, Phases 2-4 lower-risk)

### Validated Call Counts (Verified 2026-01-12)
| File (Phase 1) | Calls |
|----------------|-------|
| CrossProcessMigration.java | 8 |
| RemoteBubbleProxy.java | 6 |
| MigrationProtocolMessages.java | 6 |
| GhostStateManager.java | 4 |
| EntityMigrationStateMachine.java | 3 |
| FakeNetworkChannel.java | 5 |
| BucketSynchronizedController.java | 2 |
| VONDiscoveryProtocol.java | 2 |
| **Phase 1 Total** | **36** |

---

## Bead Hierarchy

```
Luciferase-xve9 (H3.7: Parent - in_progress)
    |
    +-- Luciferase-k0bg (H3.7.1: Phase 1 Critical) [P0]
    |        |
    +--------+-- Luciferase-txzh (H3.7.2: Phase 2 High) [P0]
             |        |
             +--------+-- Luciferase-19hp (H3.7.3: Phase 3 Medium) [P1]
                      |        |
                      +--------+-- Luciferase-6fw9 (H3.7.4: Phase 4 Low) [P1]
```

**Dependency Chain**: H3.7.1 -> H3.7.2 -> H3.7.3 -> H3.7.4

---

## Phase Breakdown

### Phase 1: Critical Files (Luciferase-k0bg)
**Priority**: P0 (BLOCKING)
**Files**: 8
**Calls**: 36 (32% of total)
**Timeline**: Days 1-2
**Risk**: HIGH - Test-affecting wall-clock usage

#### Risk-Ordered Execution Sequence

Execute files in this order (lowest risk first, building confidence):

| # | File | Calls | Risk | Path | Rationale |
|---|------|-------|------|------|-----------|
| 1 | FakeNetworkChannel.java | 5 | LOW | .../distributed/network/ | Test infrastructure, isolated |
| 2 | BucketSynchronizedController.java | 2 | LOW | .../bubble/ | Bucket timing, low coupling |
| 3 | VONDiscoveryProtocol.java | 2 | MEDIUM | .../distributed/ | Discovery timing |
| 4 | GhostStateManager.java | 4 | MEDIUM | .../ghost/ | Ghost lifecycle, foundational |
| 5 | EntityMigrationStateMachine.java | 3 | MEDIUM | .../causality/ | State transitions, depends on Ghost |
| 6 | MigrationProtocolMessages.java | 6 | HIGH | .../distributed/migration/ | Message timestamps, many dependents |
| 7 | RemoteBubbleProxy.java | 6 | HIGH | .../distributed/ | Cache TTL, timeout loops, complex logic |
| 8 | CrossProcessMigration.java | 8 | CRITICAL | .../distributed/migration/ | Highest coupling, most calls |

#### Push Batching Strategy

| Batch | Files | Push After | Tests | Checkpoint |
|-------|-------|------------|-------|------------|
| 1.1 | 1-3 | File 3 | Network + Discovery tests | Network/Discovery infra |
| 1.2 | 4-5 | File 5 | Ghost + State machine tests | Ghost/State machine |
| 1.3 | 6-7 | File 7 | Protocol + Proxy tests | Protocol/Proxy |
| 1.4 | 8 | File 8 | Full migration test suite | Phase 1 complete |

#### Per-File Test Commands

```bash
# File 1: FakeNetworkChannel
mvn test -pl simulation -Dtest=FakeNetworkChannelTest,NetworkSimulationTest

# File 2: BucketSynchronizedController
mvn test -pl simulation -Dtest=BucketSynchronizedControllerTest,WallClockBucketSchedulerTest

# File 3: VONDiscoveryProtocol
mvn test -pl simulation -Dtest=VONDiscoveryProtocolTest

# File 4: GhostStateManager
mvn test -pl simulation -Dtest=GhostStateManagerTest,GhostLifecycleTest

# File 5: EntityMigrationStateMachine
mvn test -pl simulation -Dtest=EntityMigrationStateMachineTest

# Files 6-8: Full migration suite
mvn test -pl simulation
```

**Verification Protocol**:
1. After EACH file: compile + related tests + determinism tests
2. After every batch (2-3 files): push to CI
3. If CI fails: revert latest file, investigate, fix, retry
4. Tag after Phase 1 complete: `git tag h3.7-phase1-complete`

### Phase 2: High Priority Files (Luciferase-txzh)
**Priority**: P0
**Files**: 18
**Calls**: 25 (22% of total)
**Timeline**: Days 3-4
**Risk**: MEDIUM - Business logic timestamps

**Subsystem 2A: Simulation Core (10 calls, 5 files)**
- VonBubble.java (3)
- MultiBubbleSimulation.java (2)
- TwoBubbleSimulation.java (2)
- SimulationLoop.java (2)
- BubbleLifecycle.java (1)

**Subsystem 2B: Migration Tracking (11 calls, 8 files)**
- MigrationTransaction.java (3)
- IdempotencyStore.java (3)
- MigrationCoordinator.java (1)
- IdempotencyToken.java (1)
- EntitySnapshot.java (1)
- MigrationLog.java (1)
- MigrationMetrics.java (2)

**Subsystem 2C: Process Management (4 calls, 3 files)**
- ProcessMetadata.java (2)
- ProcessRegistry.java (1)
- ProcessCoordinator.java (1)

**Verification Protocol**:
1. After each subsystem: full test suite
2. After each subsystem: push to CI
3. Commit files individually within subsystem

### Phase 3: Medium Priority Files (Luciferase-19hp)
**Priority**: P1
**Files**: 18
**Calls**: 30 (27% of total)
**Timeline**: Day 5-6
**Risk**: LOW - Metrics/monitoring only

**Subsystem 3A: Metrics Collection (18 calls, 7 files)**
- ServerMetrics.java (4)
- DemoMetricsCollector.java (5)
- DistributedSimulationMetrics.java (2)
- MetricsSnapshot.java (1)
- ObservabilityMetrics.java (1)
- GCPauseMeasurement.java (4)
- InstrumentedGhostChannel.java (2)

**Subsystem 3B: Integration & Validation (12 calls, 11 files)**
- HybridBubbleController.java (2)
- EntityMigrationLoadGenerator.java (2)
- CrossProcessMigrationValidator.java (2)
- DistributedEntityFactory.java (2)
- MessageOrderValidator.java (1)
- InjectableClock.java (1)
- ConsensusMigrationIntegration.java (1)
- OptimisticMigratorIntegration.java (1)

**Verification Protocol**:
1. Spot-check tests every 6-9 files
2. Push to CI after each subsystem
3. Full test suite at phase end

### Phase 4: Low Priority Files (Luciferase-6fw9)
**Priority**: P1
**Files**: 19
**Calls**: 23 (20% of total)
**Timeline**: Day 7
**Risk**: MINIMAL - Debug/logging only

**Subsystem 4A: Demo & Test Support (12 calls, 8 files)**
- FailureScenario.java (2)
- FailureInjector.java (1)
- ExternalBubbleTracker.java (2)
- CrossProcessNeighborIndex.java (2)
- grid/MultiBubbleSimulation.java (2)
- EntityVisualizationServer.java (1)
- GhostConsistencyValidator.java (1)
- EventReprocessor.java (1)

**Subsystem 4B: Messaging (11 calls, 11 files)**
- TopologyUpdateMessage.java (1)
- RegisterProcessMessage.java (1)
- HeartbeatMessage.java (1)
- GrpcBubbleNetworkChannel.java (2)
- HeapMonitor.java (1)
- Plus additional message classes

**Verification Protocol**:
1. Compilation check only during phase
2. Single CI run at end of phase
3. Full regression test at completion

---

## Implementation Pattern

For each file, apply this standard transformation:

```java
// 1. Add import
import com.hellblazer.luciferase.simulation.distributed.integration.Clock;

// 2. Add Clock field with setter injection
private volatile Clock clock = Clock.system();

public void setClock(Clock clock) {
    this.clock = clock;
}

// 3. Replace System.* calls
// BEFORE: var now = System.currentTimeMillis();
// AFTER:  var now = clock.currentTimeMillis();

// BEFORE: var start = System.nanoTime();
// AFTER:  var start = clock.nanoTime();
```

**For classes with existing Clock field**: Skip steps 1-2, only do step 3.

**For inner classes/lambdas**: Access clock from outer class or pass as parameter.

---

## Batch Strategy

| Phase | Files per Commit | Files per Push | Rationale |
|-------|------------------|----------------|-----------|
| 1 | 1 | 2 | Maximum safety - critical path |
| 2 | 1 | 3-5 | Moderate safety - subsystem batching |
| 3 | 1 | 5-6 | Efficient - low risk |
| 4 | 1 | All | Fast - minimal risk |

---

## Progress Tracking

### Metrics
- **Primary**: Calls converted / Total (113)
- **Secondary**: Files converted / Total (55)

### Milestones
| Milestone | Calls | Files | % Complete |
|-----------|-------|-------|------------|
| Phase 1 Complete | 35 | 8 | 31% |
| Phase 2 Complete | 60 | 26 | 53% |
| Phase 3 Complete | 90 | 44 | 80% |
| Phase 4 Complete | 113 | 55 | 100% |

### Verification Command
```bash
# Should return exactly 7 at completion
grep -rn "System\.currentTimeMillis\|System\.nanoTime" \
  simulation/src/main/java --include="*.java" | wc -l
```

---

## Risk Mitigation

### Risk Register

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Constructor signature changes break callers | MEDIUM | HIGH | Use setter injection, not constructor |
| Test failures from timing changes | HIGH (Phase 1) | HIGH | Test after EACH file in Phase 1 |
| Hidden dependencies on System.* timing | MEDIUM | MEDIUM | Full test suite validation |
| Message ordering breaks | HIGH (Phase 1) | HIGH | Run migration integration tests |
| Cache TTL behavior changes | MEDIUM | MEDIUM | Verify cache expiration in tests |

### Rollback Strategy

**Phase 1 (per-file granularity)**:
```bash
# Before starting Phase 1
git tag pre-h3.7.1

# If file N fails
git revert HEAD  # Revert single file
# Investigate, fix, retry
```

**Phase 2-4 (per-subsystem granularity)**:
```bash
# If subsystem fails
git revert HEAD~N..HEAD  # Revert N files
# Or: git reset --hard <last-green-commit>
```

**Full rollback**:
```bash
git reset --hard pre-h3.7.1
bd update k0bg --status open  # Reset beads
```

---

## Timeline

### Week 1

| Day | Phase | Activity | Deliverable |
|-----|-------|----------|-------------|
| 1 | 1 | Files 1-4: CrossProcessMigration, RemoteBubbleProxy, MigrationProtocolMessages, GhostStateManager | 24/35 calls converted |
| 2 | 1 | Files 5-8: EntityMigrationStateMachine, FakeNetworkChannel, BucketSynchronizedController, VONDiscoveryProtocol | Phase 1 complete (35/113) |
| 3 | 2 | Subsystem 2A: Simulation Core (5 files) | 45/113 calls converted |
| 4 | 2 | Subsystems 2B + 2C: Migration + Process (13 files) | Phase 2 complete (60/113) |
| 5 | 3/Buffer | Buffer for Phase 1-2 issues OR start Phase 3 | Risk mitigation |

### Week 2

| Day | Phase | Activity | Deliverable |
|-----|-------|----------|-------------|
| 6 | 3 | Complete Phase 3 (18 files, 30 calls) | Phase 3 complete (90/113) |
| 7 | 4 | Complete Phase 4 (19 files, 23 calls) + Final verification | H3.7 COMPLETE (113/113) |

**Buffer**: Day 5 provides 1 full day buffer for unexpected issues.

---

## Success Criteria

### Completion Checklist
- [ ] All 113 calls converted to Clock interface
- [ ] Zero System.currentTimeMillis/nanoTime in production code (except Clock.java, TestClock.java)
- [ ] All tests passing (mvn test -pl simulation)
- [ ] CI green for all phases
- [ ] No behavioral regressions
- [ ] Bead Luciferase-0460 (H3.6) unblocked

### Verification Commands
```bash
# Final verification - should return 7
grep -rn "System\.currentTimeMillis\|System\.nanoTime" \
  simulation/src/main/java --include="*.java" | wc -l

# Show remaining (should be Clock.java and TestClock.java only)
grep -rn "System\.currentTimeMillis\|System\.nanoTime" \
  simulation/src/main/java --include="*.java"
```

---

## Parallelization Assessment

**Can phases run in parallel?** NO

**Rationale**:
1. Sequential execution catches integration issues early
2. Clean rollback requires linear commit history
3. Clock injection pattern must be consistent across codebase
4. Test suite validation assumes complete subsystems

**Intra-phase parallelization**: Also not recommended - risk of merge conflicts and inconsistent state.

---

## Post-Completion Actions

1. **Close beads**: k0bg, txzh, 19hp, 6fw9, xve9
2. **Unblock H3.6**: Bead Luciferase-0460 becomes actionable
3. **Update audit doc**: Mark simulation/doc/H3.7_WALL_CLOCK_AUDIT.md as COMPLETED
4. **Knowledge persistence**: Store completion summary in ChromaDB
5. **Enable determinism tests**: Can now re-enable disabled tests in H3.6

---

## Agent Handoff Instructions

**For executing agent (java-developer or similar)**:

1. Read this plan and simulation/doc/H3.7_WALL_CLOCK_AUDIT.md
2. Start with Phase 1, file 1 (CrossProcessMigration.java)
3. Follow implementation pattern exactly
4. Verify after each file per phase protocol
5. Update bead status as work progresses
6. If blocked, document in bead notes and escalate

**Context pointers**:
- Clock interface: `simulation/src/main/java/.../Clock.java`
- TestClock: `simulation/src/test/java/.../TestClock.java`
- Prior H3 work: H3.1-H3.5 (completed, see beads)

---

**Plan Created**: 2026-01-12
**Plan Revised**: 2026-01-12
**Plan Author**: strategic-planner (Opus 4.5)
**Awaiting**: plan-auditor review before execution

---

## Appendix A: Full File Paths

### Phase 1 Files
```
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/network/FakeNetworkChannel.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/bubble/BucketSynchronizedController.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/VONDiscoveryProtocol.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/ghost/GhostStateManager.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/causality/EntityMigrationStateMachine.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/MigrationProtocolMessages.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/RemoteBubbleProxy.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/CrossProcessMigration.java
```

### Phase 2 Files
```
# 2A: Simulation Core
simulation/src/main/java/com/hellblazer/luciferase/simulation/bubble/BubbleLifecycle.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/loop/SimulationLoop.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/TwoBubbleSimulation.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/MultiBubbleSimulation.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/von/VonBubble.java

# 2B: Migration Tracking
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/EntitySnapshot.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/IdempotencyToken.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/ghost/MigrationLog.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/MigrationMetrics.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/MigrationCoordinator.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/IdempotencyStore.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/migration/MigrationTransaction.java

# 2C: Process Management
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/ProcessCoordinator.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/ProcessRegistry.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/ProcessMetadata.java
```

### Clock Interface Location
```
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/integration/Clock.java
simulation/src/main/java/com/hellblazer/luciferase/simulation/distributed/integration/TestClock.java
```

---

## Appendix B: Special Handling Notes

### InjectableClock.java (Phase 3)
This file may require special review - it's a clock injection test that may already be designed for Clock interface integration. Verify before converting.

### Record Classes
If any target files are Java records, Clock cannot be added as an instance field. Options:
1. Convert record to class
2. Pass Clock as method parameter
3. Add Clock component to record

### Static Methods
If static methods use System.*:
1. Convert to instance method (preferred)
2. Add static Clock parameter
3. Use Clock.system() as default with override capability

### Lambda Captures
If lambdas capture System.*:
```java
// BEFORE
Runnable r = () -> System.currentTimeMillis();

// AFTER
var localClock = this.clock;  // Capture reference
Runnable r = () -> localClock.currentTimeMillis();
```

---

## Appendix C: Progress Dashboard Template

Copy this template to track execution:

```
=== H3.7 Wall-Clock Conversion Progress ===
Date: YYYY-MM-DD HH:MM

Overall: [XX/113] calls converted (YY%)

Phase 1 (Critical):    [ZZ/36] █████░░░░░
Phase 2 (High):        [AA/25] ░░░░░░░░░░
Phase 3 (Medium):      [BB/30] ░░░░░░░░░░
Phase 4 (Low):         [CC/22] ░░░░░░░░░░

Current Phase: 1
Current File: #N - FileName.java
Last CI Status: GREEN/RED/PENDING
Last Commit: <hash> "<message>"

Blockers: None | <description>
ETA: Day X of 8.5

Next Actions:
1. [ ] <action>
2. [ ] <action>
```

---

## Revision History

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-12 | 1.0 | Initial plan creation |
| 2026-01-12 | 2.0 | Added risk-ordered execution, validated call counts, detailed test commands, appendices |
